/**
 * Atomically upserts a test run record.
 * - If the record does not exist, it is inserted.
 * - If the record exists AND its status is 'pending', it is updated.
 * - If the record exists AND its status is not 'pending', nothing happens.
 *
 * @param db Database instance
 * @param data Test run data to upsert
 * @returns A promise that resolves with the row's ID if an insert/update occurred, otherwise null.
 */
export function upsertTestRun(db: Database, data: TestRun): Promise<number | null> {
    return new Promise((resolve, reject) => {
        const sql = `
            INSERT INTO test_runs (
                test_id,
                test_name,
                test_search_name,
                status,
                start_time,
                end_time,
                result,
                error,
                duration_ms,
                test_sequence
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ON CONFLICT(test_id, test_name) DO UPDATE SET
                status = excluded.status,
                end_time = excluded.end_time,
                result = excluded.result,
                error = excluded.error,
                duration_ms = excluded.duration_ms,
                test_sequence = excluded.test_sequence
            -- THIS IS THE CRUCIAL ADDITION:
            -- The WHERE clause applies to the existing row in the 'test_runs' table.
            -- The update will only happen if the existing row's status is 'pending'.
            WHERE test_runs.status = 'pending'
            RETURNING id;
        `;

        const params = [
            data.test_id,
            data.test_name,
            data.test_search_name,
            data.status,
            data.start_time || new Date().toISOString(),
            data.end_time || null,
            data.result || null,
            data.error || null,
            data.duration_ms || null,
            data.test_sequence || null,
        ];

        // Use db.get() because RETURNING returns a single row (or nothing).
        db.db.get(sql, params, function (err, row: { id: number } | undefined) {
            if (err) {
                return reject(err);
            }
            // If `row` is undefined, it means an update was skipped due to the WHERE clause.
            // We resolve with `row.id` if it exists, otherwise `null`.
            resolve(row ? row.id : null);
        });
    });
}
